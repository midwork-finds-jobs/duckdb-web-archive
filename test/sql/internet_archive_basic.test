# name: test/sql/internet_archive_basic.test
# description: Basic tests for internet_archive function
# group: [internet_archive]

require common_crawl

# Test that internet_archive function exists
statement ok
SELECT * FROM internet_archive() LIMIT 0;

# Test that the function returns the expected columns
query I
SELECT column_name FROM (
    DESCRIBE SELECT * FROM internet_archive()
) ORDER BY column_name;
----
cdx_url
digest
length
mimetype
response
statuscode
timestamp
url
urlkey

# Test column types for basic fields
query II
SELECT column_name, column_type FROM (
    DESCRIBE SELECT * FROM internet_archive()
) WHERE column_name IN ('url', 'statuscode', 'length', 'urlkey')
ORDER BY column_name;
----
length	BIGINT
statuscode	INTEGER
url	VARCHAR
urlkey	VARCHAR

# Test response column type (BLOB for internet_archive)
query II
SELECT column_name, column_type FROM (
    DESCRIBE SELECT * FROM internet_archive()
) WHERE column_name = 'response';
----
response	BLOB

# Test named parameter max_results
statement ok
SELECT * FROM internet_archive(max_results := 10) LIMIT 0;

# Test that function works without parameters (uses default)
statement ok
SELECT * FROM internet_archive() LIMIT 0;

# Test projection - only url column
query I
SELECT column_name FROM (
    DESCRIBE SELECT url FROM internet_archive()
);
----
url

# Test projection - multiple columns
query I
SELECT column_name FROM (
    DESCRIBE SELECT url, statuscode, timestamp FROM internet_archive()
) ORDER BY column_name;
----
statuscode
timestamp
url

# Test WHERE clause with url (exact match)
statement ok
SELECT * FROM internet_archive()
WHERE url = 'archive.org'
LIMIT 0;

# Test WHERE clause with url LIKE (prefix match)
statement ok
SELECT * FROM internet_archive()
WHERE url LIKE 'archive.org/%'
LIMIT 0;

# Test WHERE clause with url LIKE (domain match)
statement ok
SELECT * FROM internet_archive()
WHERE url LIKE '%.archive.org'
LIMIT 0;

# Test WHERE clause with statuscode
statement ok
SELECT * FROM internet_archive()
WHERE statuscode = 200
LIMIT 0;

# Test WHERE clause with mimetype
statement ok
SELECT * FROM internet_archive()
WHERE mimetype = 'text/html'
LIMIT 0;

# Test multiple WHERE conditions
statement ok
SELECT * FROM internet_archive()
WHERE url = 'archive.org'
  AND statuscode = 200
  AND mimetype = 'text/html'
LIMIT 0;

# Test LIMIT
statement ok
SELECT * FROM internet_archive()
WHERE url = 'archive.org'
LIMIT 0;

# Test accessing response body
statement ok
SELECT url, octet_length(response) as size FROM internet_archive()
WHERE url = 'archive.org'
  AND statuscode = 200
LIMIT 0;

# Test timestamp column
statement ok
SELECT url, timestamp FROM internet_archive()
WHERE url = 'archive.org'
ORDER BY timestamp DESC
LIMIT 0;
