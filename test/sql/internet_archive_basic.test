# name: test/sql/internet_archive_basic.test
# description: Basic tests for internet_archive function
# group: [sql]

require web_archive_cdx

# Test that internet_archive function exists
statement ok
SELECT * FROM wayback_machine() LIMIT 0;

# Test that the function returns the expected columns (cdx_url hidden by default)
query I
SELECT column_name FROM (
    DESCRIBE SELECT * FROM wayback_machine()
) ORDER BY column_name;
----
archive_url
digest
length
mimetype
response
statuscode
timestamp
url
urlkey

# Test that cdx_url column is shown when debug := true
query I
SELECT column_name FROM (
    DESCRIBE SELECT * FROM wayback_machine(debug := true)
) ORDER BY column_name;
----
archive_url
cdx_url
digest
length
mimetype
response
statuscode
timestamp
url
urlkey

# Test column types for basic fields
query II
SELECT column_name, column_type FROM (
    DESCRIBE SELECT * FROM wayback_machine()
) WHERE column_name IN ('url', 'statuscode', 'length', 'urlkey')
ORDER BY column_name;
----
length	BIGINT
statuscode	INTEGER
url	VARCHAR
urlkey	VARCHAR

# Test response column type (STRUCT with body and error for wayback_machine)
query II
SELECT column_name, column_type FROM (
    DESCRIBE SELECT * FROM wayback_machine()
) WHERE column_name = 'response';
----
response	STRUCT(body BLOB, "error" VARCHAR)

# Test named parameter max_results
statement ok
SELECT * FROM wayback_machine(max_results := 10) LIMIT 0;

# Test that function works without parameters (uses default)
statement ok
SELECT * FROM wayback_machine() LIMIT 0;

# Test projection - only url column
query I
SELECT column_name FROM (
    DESCRIBE SELECT url FROM wayback_machine()
);
----
url

# Test projection - multiple columns
query I
SELECT column_name FROM (
    DESCRIBE SELECT url, statuscode, timestamp FROM wayback_machine()
) ORDER BY column_name;
----
statuscode
timestamp
url

# Test WHERE clause with url (exact match)
statement ok
SELECT * FROM wayback_machine()
WHERE url = 'archive.org'
LIMIT 0;

# Test WHERE clause with url LIKE (prefix match)
statement ok
SELECT * FROM wayback_machine()
WHERE url LIKE 'archive.org/%'
LIMIT 0;

# Test WHERE clause with url LIKE (domain match)
statement ok
SELECT * FROM wayback_machine()
WHERE url LIKE '%.archive.org'
LIMIT 0;

# Test WHERE clause with statuscode
statement ok
SELECT * FROM wayback_machine()
WHERE statuscode = 200
LIMIT 0;

# Test WHERE clause with mimetype
statement ok
SELECT * FROM wayback_machine()
WHERE mimetype = 'text/html'
LIMIT 0;

# Test multiple WHERE conditions
statement ok
SELECT * FROM wayback_machine()
WHERE url = 'archive.org'
  AND statuscode = 200
  AND mimetype = 'text/html'
LIMIT 0;

# Test LIMIT
statement ok
SELECT * FROM wayback_machine()
WHERE url = 'archive.org'
LIMIT 0;

# Test accessing response body
statement ok
SELECT url, octet_length(response.body) as size FROM wayback_machine()
WHERE url = 'archive.org'
  AND statuscode = 200
LIMIT 0;

# Test timestamp column
statement ok
SELECT url, timestamp FROM wayback_machine()
WHERE url = 'archive.org'
ORDER BY timestamp DESC
LIMIT 0;

# Test archive_url column type
query II
SELECT column_name, column_type FROM (
    DESCRIBE SELECT archive_url FROM wayback_machine()
);
----
archive_url	VARCHAR

# Test archive_url column is selectable
statement ok
SELECT archive_url FROM wayback_machine()
WHERE url = 'archive.org'
LIMIT 0;

# Test DISTINCT ON(digest) pushes down collapse=digest to CDX API
query I
SELECT cdx_url LIKE '%&collapse=digest%' AS has_collapse
FROM (SELECT DISTINCT ON(digest) cdx_url FROM wayback_machine(debug := true) WHERE url = 'archive.org');
----
true
